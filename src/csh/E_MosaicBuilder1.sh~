#!/bin/csh
#===========================================================================================================
#MosaicBuilder.sh
#Contact: Erith Alexander Mu√±oz (erith7@gmail.com), FAO-Ecuador
#version: v.1.0
#
#Date:24/02/2016
#
#	Description: 
#	
#	This script is could be used in order to genarate a mosaic image since the execution of the LandsatPreprocessV1.2.sh 
#	code. For this reason, this code is able to look into the data estructure generated by LandsatPreprocessV1.2.sh, and copy the last compositos
#	for each Path-Row in a new directory (CompositeFile), to project each of them, and after to build a mosaic.
#	

#
#	USE:
#	The variables LandsatSource, CompositeFile, EPSG, and outname,  must be configured in order to 
#	executing the script in a proper way. 
#
#	Important: Installation of the CSH interpreter is required for the successful execution of this script.
#	execution: ./MosaicBuilder.sh
#
#============================================================================================================

set LandsatSource=/media/erith/FAO_EC1/FAO/BNB/datos/ChangeMap/OFGT/2015/CloudMasked/ #Path to the path-row directory where the compositos are located. This file is the OutputImages directory
#                                                                               defined for the  LandsatPreprocessV1.2.sh script during the compositos generation step (with "/" at the end)
set CompositeFile=/media/erith/FAO_EC1/FAO/BNB/datos/ChangeMap/OFGT/2015/Mosaico  #Location where it will be saved all the compositos (without "/" at the end)
set EPSG=32617  #projection to apply for all the images
set outname = "mosaico2014_LPP.tif" #name of the mosaic to be built


echo "==============================================================="
echo "| Path Reading....                                            |"
echo "==============================================================="
echo $LandsatSource
echo $CompositeFile
echo "==============================================================="
echo "| Path Reading Done....                                       |"
echo "==============================================================="

set tt=0

if ($tt != 1) then  #This loop is just used to control the part of the code to be executed during test. If you want to execute
#                    all the code, you have to set tt=0 (or whatever different to 1). But if you already executed the code, and you want 
#                    just to execute a part of it, you have to set tt=1, and move the "endif" sentence at the end of the part of the code that you do not want to run. 

#===========================================================================================================
#listing of all the path-row images
#===========================================================================================================

	if (! -d $CompositeFile) mkdir -p $CompositeFile
	cd $LandsatSource
	set LandsatFileList = `ls -1`
	echo "Number of Path-Row Directories:" $#LandsatFileList
	@ PathRowId = 1

#===========================================================================================================
#Getting in each path-row file 
#===========================================================================================================

foreach inpfile ($LandsatFileList)  # Making the Path/Row Files List
echo "=============================================================================="
echo "| Reading Path-Row:"$LandsatFileList[$PathRowId]"                             "
echo "| Processing Path-Row file :" $PathRowId "of" $#LandsatFileList"              "
echo "=============================================================================="

		echo $inpfile
		set pathrow = $inpfile'/'  # Defining the PathRow Directory
		cd $LandsatSource$inpfile

# Getting in each PathRow File  

#===========================================================================================================
#Listing of all the compositos in every path-row file
#===========================================================================================================

		set Imagelist = `ls -t fillndvi2*.tif`  

		if ("x$Imagelist" == "x") then
			echo "This composito was integrated by using just 1 L8 image"
			set ImageUnique = `ls -t *ndvi.tif`

			if ("x$ImageUnique" == "x") then
				echo "there is not a image to be used in the mosaic generation in this file"
			else
				set ImageToCopyUnique = $ImageUnique[1]
				echo "The composito selected to build the mosaic is:" $ImageToCopyUnique
				cp ./$ImageToCopyUnique $CompositeFile'/'$inpfile'.tif'
			endif
		else
			echo "Number of Compositos in the Path-Row :" $#Imagelist 
			echo "This is Imagelist :" $Imagelist
			set ImageToCopy = $Imagelist[1]
			echo "The composito selected to build the mosaic is:" $ImageToCopy
			cp ./$ImageToCopy $CompositeFile'/'$inpfile'.tif'
		endif

		cd $LandsatSource
		@ PathRowId += 1
end

#===========================================================================================================
#Mosaic Generation
#===========================================================================================================
echo ""
echo ""
echo ""
echo ""
echo "=============================================================================="
echo "| In this Step, the re-projection of the original compositos is performed      "                    
echo "|                                                                             "
echo "=============================================================================="
echo ""
echo ""
echo ""
		cd $CompositeFile
		@ ImageId = 1
		set compositosRP=`ls -t`
		echo "List of compositos to be re-projected:  "$compositosRP
		foreach compoVar ($compositosRP)
		set name=`expr substr $compoVar 1 5`
		

echo "=============================================================================="
echo "| Projecting the composito:" $compoVar "("$ImageId" of" $#compositosRP")     "
echo "| Implementing EPSG: " $EPSG
echo "=============================================================================="

		gdalwarp -t_srs EPSG:$EPSG $compoVar $name'_proj.tif'
		@ ImageId += 1
		rm $compoVar
		end

endif  # if tt=1, please move these line to the end of the code you do not want to run.

echo ""
echo ""
echo ""
echo ""
echo "=============================================================================="
echo "| In this Step, the mosaic is built                                           "                    
echo "|                                                                             "
echo "=============================================================================="
echo ""
echo ""
echo ""
		cd $CompositeFile	
		echo "My position is :" $CompositeFile	
		set compoProj = `ls -t *_proj.tif`
		echo "List of compositos to be merged:   "$compoProj
		echo "The mosaic name is:  " $outname
		gdal_merge.py -n 0 -o $outname $compoProj
		echo "That's all folks!!!"

exit
